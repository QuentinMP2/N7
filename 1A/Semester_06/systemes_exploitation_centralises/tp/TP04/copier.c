#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <string.h>
#include <fcntl.h>

#define BUFSIZE 1

int main(int argc, char** argv) {
    char* tampon[BUFSIZE];

    // Vérifier le bon nombre d'arguments
    if (argc != 3) {
        char msg[100];
        sprintf(msg, "Usage : %s source destination \n", argv[0]);
        write(2, msg, strlen(msg));
        exit(EXIT_FAILURE);
    }

    int src, desc;

    // Ouvrir la source
    if ((src = open(argv[1], O_RDONLY)) == -1) {
        char msg[100];
        sprintf(msg, "Erreur ouverture source %s\n", argv[0]);
        write(2, msg, strlen(msg));
        exit(EXIT_FAILURE);
    }

    // Ouvrir la destination
    if ((desc = open(argv[2], O_WRONLY | O_CREAT | O_TRUNC, 0644)) == -1) {
        char msg[100];
        sprintf(msg, "Erreur ouverture destination %s\n", argv[0]);
        write(2, msg, strlen(msg));
        exit(EXIT_FAILURE);
    }

    int nbLus;
    // Lecture depuis source, écriture sur destination
    while ((nbLus = read(src, &tampon, BUFSIZE)) > 0) {
        if(write(desc, &tampon, BUFSIZE) != nbLus) {
            char msg[100];
            sprintf(msg, "Erreur écriture destination %s\n", argv[0]);
            write(2, msg, strlen(msg));
            exit(EXIT_FAILURE);
        }
    }

    // Fermeture des fichiers
    if (close(src) == -1) {
        char msg[100];
        sprintf(msg, "Erreur fermeture source %s\n", argv[0]);
        write(2, msg, strlen(msg));
        exit(EXIT_FAILURE);
    }

    if (close(desc) == -1) {
        char msg[100];
        sprintf(msg, "Erreur fermeture destination %s\n", argv[0]);
        write(2, msg, strlen(msg));
        exit(EXIT_FAILURE);
    }
}
